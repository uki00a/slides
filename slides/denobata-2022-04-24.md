---
title: Denoã°ãŸä¼šè­° Monthly ç¬¬8å›
description: Denoã°ãŸä¼šè­° Monthly ç¬¬8å›
keywords: Deno
url: https://uki00a.github.io/slides/denobata-2022-04-24
---

# Denoã°ãŸä¼šè­° Monthly ç¬¬8å›

<!-- _class: lead -->

---

## Deno v1.21

<!-- _class: lead -->

---

### `deno check`ã‚³ãƒãƒ³ãƒ‰

æŒ‡å®šã•ã‚ŒãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‹ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ã‚³ãƒãƒ³ãƒ‰

```shell
$ deno check mod.ts
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã®è¿½åŠ ã«ã‚ˆã‚Šã€**`deno run`ã‚³ãƒãƒ³ãƒ‰ã§ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹ãƒã‚§ãƒƒã‚¯ã¯å°†æ¥çš„ã«ç„¡åŠ¹åŒ–ã•ã‚Œã‚‹äºˆå®šã§ã™ã€‚**

---

### æ–°ã—ã„ã‚µãƒ–ãƒ—ãƒ­ã‚»ã‚¹API

Denoåå‰ç©ºé–“ã«`spawn`, `spawnChild`, åŠã³`spawnSync`ã®3ã¤ã®APIãŒè¿½åŠ 

**é«˜ãƒ¬ãƒ™ãƒ«API**

```ts
const { stdout, status } = await Deno.spawn("echo", {
  args: ["foo"],
});
console.assert("foo\n" === new TextDecoder().decode(stdout));
console.assert(status.success);
```

---

**ä½ãƒ¬ãƒ™ãƒ«API**

```ts
const child = Deno.spawnChild("deno", {
  args: ["--version"],
});
for await (const output of child.stdout.pipeThrough(new TextDecoderStream())) {
  console.log(output);
}
```

```ts
const child = Deno.spawnChild("gh", {
  args: ["issue", "list"],
});
const { stdout, status } = await child.output();
console.assert(status.success);
console.log(new TextDecoder().decode(stdout));
```

---

### `deno test`ã®æ”¹å–„

`TestContext`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«é–¢ã™ã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒè¿½åŠ  (`name`, `origin`, åŠã³`parent`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£)

```ts
Deno.test("math", async (t) => {
  assert(t.name === "math");
  assert(t.origin === Deno.mainModule);
  await t.step("sum", (t) => {
    assert(t.parent.name === "math");
    assert(t.name === "sum");
    assert(6 === sum(1, 2, 3));
  });
});
```

---

**ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®æ”¹å–„**

```js
Deno.test("foo", () => {
  console.log({ message: "foo" });
  console.log("baz");
});
```

`console.log()`ã§å‡ºåŠ›ã•ã‚ŒãŸå†…å®¹ãŒãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã«ã‚ˆã£ã¦è£œè¶³ã•ã‚Œã¾ã™:

```shell
running 1 test from ./sample_test.js
foo ...
------- output -------
{ message: "foo" }
baz
----- output end -----
```

---

### `deno fmt`ã¨`deno lint`ã®å¤§å¹…ãªé«˜é€ŸåŒ–

`deno fmt`ã¨`deno lint`ã§ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸã€‚

ã“ã‚Œã‚‰ã®ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œçµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ã§ã€å¤§å¹…ãªé«˜é€ŸåŒ–ãŒè¦‹è¾¼ã¾ã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚

---

### `deno bench`ã®æ”¹å–„

`n`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨`warmup`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã¾ã™ã€‚

```js
Deno.bench("URLPattern", () => {
  const pattern = new URLPattern({ pathname: "/users/:id" });
  pattern.test("http://locahost:3000/users/123");
});
```

ä»Šå¾Œã¯ã€Denoæœ¬ä½“ãŒä¿¡é ¼ã®ã‚ã‚‹çµæœã‚’å¾—ã‚‰ã‚Œã‚‹ã¾ã§ç¹°ã‚Šè¿”ã—ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã‚Œã¾ã™ã€‚

---

**ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã®ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°**

```js
Deno.bench({ name: "add", group: "math", baseline: true, fn: () => add(1, 2) });
Deno.bench({ name: "sum", group: "math", fn: () => sum(1, 2, 3, 4, 5) });
```

ãƒ¬ãƒãƒ¼ãƒˆ:

```shell
benchmark      time (avg)             (min â€¦ max)       p75       p99      p995
------------------------------------------------- -----------------------------
add        169.17 ns/iter    (157.29 ns â€¦ 249 ns) 169.19 ns 221.56 ns 246.76 ns
sum        192.72 ns/iter (187.26 ns â€¦ 255.52 ns) 193.52 ns  228.4 ns 230.39 ns
summary
  add
   1.14x times faster than sum
```

---

### [reportError()](https://developer.mozilla.org/en-US/docs/Web/API/reportError)ã®ã‚µãƒãƒ¼ãƒˆ

Uncaught exceptionã‚’æ˜ç¤ºçš„ã«ç™ºç”Ÿã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
addEventListener("error", e => {
  console.error(e.error);
  e.preventDefault(); // ã“ã‚Œã‚’å‘¼ã°ãªã„ã¨exit code=1ã§çµ‚äº†ã™ã‚‹
});
reportError(new Error("foo"));
```

---

### `deno repl`ã®æ”¹å–„

`--eval-file`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¿½åŠ ã•ã‚Œã€REPLã®èµ·å‹•å‰ã«èª­ã¿è¾¼ã¿ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```shell
$ deno repl --eval-file=sum.js
Deno 1.21.0
exit using ctrl+d or close()
> sum(1, 2, 3)
6
```

ãã®ä»–ã«ã‚‚ã€`clear()`é–¢æ•°ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚(æŒ™å‹•ã¯`console.clear()`ã¨åŒç­‰)

---

### `Deno.Listener`ã«`ref`ã¨`unref`ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¿½åŠ  (unstable)

`unref()`ãŒå‘¼ã°ã‚ŒãŸ`Listener`ã¯ãƒ—ãƒ­ã‚»ã‚¹ã®çµ‚äº†ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªããªã‚Šã¾ã™ (ã‚¿ã‚¤ãƒã«`Deno.unrefTimer`ã‚’å‘¼ã‚“ã ã¨ãã¨åŒæ§˜ã®æŒ™å‹•ã‚’ã—ã¾ã™)

[deno_std/node/net](https://deno.land/std@0.136.0/node/net.ts)ã§ã®`Server.ref()`ã‚„`Server.unref()`ã®å®Ÿè£…ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

---

### `DENO_NO_PROMPT`ç’°å¢ƒå¤‰æ•°ã®ã‚µãƒãƒ¼ãƒˆ

ã“ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹ã¨ã€[Deno v1.19ã§æœ‰åŠ¹åŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æŒ™å‹•](https://deno.com/blog/v1.19)ã‚’ç„¡åŠ¹åŒ–ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚(`--no-prompt`ã‚’æŒ‡å®šã—ãŸã¨ãã¨åŒæ§˜ã®æŒ™å‹•ã§ã™)

```shell
$ DENO_NO_PROMPT=1 deno run main.ts
```

---

## deno_stdã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ

<!-- _class: lead -->

---

### `testing/mock`

```tsx
import { assertSpyCall, assertSpyCalls, spy } from "https://deno.land/std@0.136.0/testing/mock.ts";

const add = (a, b) => a + b;
const addSpy = spy(add);

assertEquals(addSpy(1, 2), 3); // => OK
assertEquals(addSpy(2, 3), 5); // => OK
assertSpyCall(addSpy, 0, {
  args: [1, 2],
  returned: 3,
}); // => OK
assertSpyCall(addSpy, 1, {
  args: [2, 3],
  returned: 5,
}); // => OK

assertSpyCalls(addSpy, 2); // => OK
```

---

### `testing/bdd`
    
```ts
import { assertEquals } from "https://deno.land/std@0.136.0/testing/asserts.ts";
import { describe, it } from "https://deno.land/std@0.136.0/testing/bdd.ts";

describe("sum", () => {
  it("should return sum of numbers", () => {
    assertEquals(sum(1, 2, 5), 8)
  });

  it("should return 0 when no arguments are given", () => {
    assertEquals(sum(), 0);
  });
});
```

å®šç¾©ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¯`deno test`ã§å®Ÿè¡Œã§ãã¾ã™ã€‚

---

### `testing/time`

```ts
import { afterEach, beforeEach, describe, it } from "https://deno.land/std@0.136.0/testing/bdd.ts"
import { assertSpyCalls, spy } from "https://deno.land/std@0.136.0/testing/mock.ts";
import { FakeTime } from "https://deno.land/std@0.136.0/testing/time.ts";

describe("FakeTime", () => {
  let fakeTime;
  beforeEach(() => {
    fakeTime = new FakeTime("2022-04-01T00:00:00.000Z");
  });
  afterEach(() => fakeTime.restore());

  it("replaces Date with fake implementation", () => {
    assertEquals("2022-04-01T00:00:00.000Z", new Date().toISOString());
  });

  it("replaces setInterval with fake implementation", () => {
    const cb = spy();
    const intervalID = setInterval(cb, 2000);
    fakeTime.tick(7000);
    try {
      assertSpyCalls(cb, 3);
    } finally {
      clearInterval(intervalID);
    }
  });
});
```

---

### `testing/snapshot`

```ts
import { assertSnapshot } from "https://deno.land/std@0.136.0/testing/snapshot.ts"

Deno.test("doSomething", async (t) => {
  const result = doSomething();
  await assertSnapshot(t, result);
});
```

ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®æ›´æ–°:

```shell
# ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¯__snapshots__ã«æ›¸ãè¾¼ã¾ã‚Œã¾ã™
$ deno test --allow-read --allow-write tests/some_test.js -- --update
```

---

## [Supabase Functions](https://deno.com/blog/supabase-functions-on-deno-deploy)

[Supabase](https://supabase.com/)ã§Supabase Functionsã¨ã„ã†FaaSãŒåˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

Supabase Functionsã¯Deno Deployã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦ãŠã‚Šã€TypeScriptãªã©ã‚’åˆ©ç”¨ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã§ãã¾ã™ã€‚

---

## [Netlify Edge Functions (public beta)](https://deno.com/blog/netlify-edge-functions-on-deno-deploy)

Netlifyã®Edgeãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§JavaScriptã‚„TypeScripté–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™

ç¾åœ¨ã€[Remix](https://github.com/netlify/remix-edge-template)ã‚„[Astro](https://astro.build/blog/netlify-edge-functions/), [Nuxt3](https://docs.netlify.com/integrations/frameworks/nuxt/#edge-functions)ãªã©æ§˜ã€…ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§Netlify Edge Functionsã®ã‚µãƒãƒ¼ãƒˆãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™

---

## [Aleph.js v1 alpha](https://github.com/alephjs/aleph.js/releases/tag/1.0.0-alpha.1)

- [Deno Deployã®ã‚µãƒãƒ¼ãƒˆ](https://github.com/alephjs/alephjs.org/pull/58)
- Remixãƒ©ã‚¤ã‚¯ãªãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿API
- Reactä»¥å¤–ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ã‚µãƒãƒ¼ãƒˆ ([Vue.js](https://github.com/alephjs/aleph.js/tree/1.0.0-alpha.1/framework/vue))
- UnoCSSã®çµ„ã¿è¾¼ã¿ã‚µãƒãƒ¼ãƒˆ
- `ts`/`jsx`/`tsx`ã®ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ã§ã®å¤‰æ›

---

## [Ultra v0.8.0](https://github.com/exhibitionist-digital/ultra/releases/tag/v0.8.0)

- React v18ã®ã‚µãƒãƒ¼ãƒˆ
- APIãƒ«ãƒ¼ãƒˆã®ã‚µãƒãƒ¼ãƒˆ (`src/api/**.{ts,js}`)
- `deno.json`ã¨ã®çµ±åˆ
- ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ™ãƒ³ãƒ€ãƒªãƒ³ã‚°
- Oakã¨ã®äº’æ›æ€§

ãªã©ã€æ§˜ã€…ãªå¤‰æ›´ãŒå®Ÿæ–½ã•ã‚Œã¦ã„ã¾ã™ã€‚

---

## [stripe-nodeãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã®Denoã‚µãƒãƒ¼ãƒˆã«ã¤ã„ã¦](https://github.com/stripe/stripe-node/issues/997#issuecomment-1104276450)

[stripe-node](https://github.com/stripe/stripe-node)ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒDenoã§ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã‚ˆã†ã§ã™ã€‚

[aiotterã•ã‚“](https://twitter.com/aiotter_tech/status/1517335820633444352)ã«æƒ…å ±æä¾›ã„ãŸã ãã¾ã—ãŸğŸ™ğŸ™
